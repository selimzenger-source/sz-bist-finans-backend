{% extends "admin/base.html" %}
{% block title %}Bildirim GÃ¶nder{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto space-y-6">

    <!-- BaÅŸarÄ± mesajÄ± -->
    {% if success %}
    <div class="bg-green-900/50 border border-green-600 text-green-300 px-4 py-3 rounded-lg flex items-center gap-2">
        <span class="text-lg">âœ…</span>
        <span>{{ success }}</span>
    </div>
    {% endif %}

    <!-- Hata mesajÄ± -->
    {% if error %}
    <div class="bg-red-900/50 border border-red-600 text-red-300 px-4 py-3 rounded-lg flex items-center gap-2">
        <span class="text-lg">âŒ</span>
        <span>{{ error }}</span>
    </div>
    {% endif %}

    <!-- Cooldown uyarÄ±sÄ± -->
    {% if not can_send %}
    <div class="bg-yellow-900/50 border border-yellow-600 text-yellow-300 px-4 py-3 rounded-lg flex items-center gap-2">
        <span class="text-lg">â³</span>
        <span>Rate limit aktif â€” <strong>{{ cooldown_remaining }}</strong> saniye bekleyin</span>
    </div>
    {% endif %}

    <!-- Ana Form KartÄ± -->
    <div class="bg-gray-800 rounded-xl shadow-lg border border-gray-700 p-6">
        <h1 class="text-xl font-bold text-gray-100 mb-6 flex items-center gap-2">
            ğŸ“¢ Toplu Bildirim GÃ¶nder
        </h1>

        <form id="broadcastForm" method="post" action="/admin/broadcast/send"
              onsubmit="return confirmBroadcast()">

            <!-- BaÅŸlÄ±k -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-1">
                    BaÅŸlÄ±k <span class="text-gray-500">(max 100 karakter)</span>
                </label>
                <input type="text" name="title" id="titleInput" maxlength="100" required
                       class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2
                              text-gray-100 placeholder-gray-500
                              focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                       placeholder="Ã–rnek: Yeni Ã–zellik! Tavan Takip ArtÄ±k Ãœcretsiz" />
                <div class="text-xs text-gray-500 mt-1">
                    <span id="titleCount">0</span>/100
                </div>
            </div>

            <!-- Mesaj -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-1">
                    Mesaj <span class="text-gray-500">(max 500 karakter)</span>
                </label>
                <textarea name="body" id="bodyInput" maxlength="500" rows="4" required
                          class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2
                                 text-gray-100 placeholder-gray-500
                                 focus:ring-2 focus:ring-indigo-500 focus:border-transparent
                                 resize-none"
                          placeholder="Bildirim mesajÄ±nÄ±zÄ± yazÄ±n..."></textarea>
                <div class="text-xs text-gray-500 mt-1">
                    <span id="bodyCount">0</span>/500
                </div>
            </div>

            <!-- Hedef Kitle -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-2">
                    Hedef Kitle
                </label>
                <div class="grid grid-cols-3 gap-3">
                    <label class="flex items-center gap-2 bg-gray-700 rounded-lg px-3 py-2.5 cursor-pointer
                                  border border-gray-600 hover:border-indigo-500 transition has-[:checked]:border-indigo-500 has-[:checked]:bg-indigo-900/30">
                        <input type="radio" name="audience" value="all" checked
                               class="text-indigo-500 focus:ring-indigo-500" onchange="updatePreview()" />
                        <div>
                            <div class="text-gray-200 text-sm font-medium">TÃ¼mÃ¼</div>
                            <div class="text-gray-500 text-xs">TÃ¼m kullanÄ±cÄ±lar</div>
                        </div>
                    </label>
                    <label class="flex items-center gap-2 bg-gray-700 rounded-lg px-3 py-2.5 cursor-pointer
                                  border border-gray-600 hover:border-emerald-500 transition has-[:checked]:border-emerald-500 has-[:checked]:bg-emerald-900/30">
                        <input type="radio" name="audience" value="paid"
                               class="text-emerald-500 focus:ring-emerald-500" onchange="updatePreview()" />
                        <div>
                            <div class="text-gray-200 text-sm font-medium">Ãœcretli</div>
                            <div class="text-gray-500 text-xs">Premium aboneler</div>
                        </div>
                    </label>
                    <label class="flex items-center gap-2 bg-gray-700 rounded-lg px-3 py-2.5 cursor-pointer
                                  border border-gray-600 hover:border-orange-500 transition has-[:checked]:border-orange-500 has-[:checked]:bg-orange-900/30">
                        <input type="radio" name="audience" value="free"
                               class="text-orange-500 focus:ring-orange-500" onchange="updatePreview()" />
                        <div>
                            <div class="text-gray-200 text-sm font-medium">Ãœcretsiz</div>
                            <div class="text-gray-500 text-xs">Free kullanÄ±cÄ±lar</div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- YÃ¶nlendirme -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-300 mb-1">
                    TÄ±klanÄ±nca YÃ¶nlendirme
                </label>
                <select name="deep_link_target"
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2
                               text-gray-100 focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    <option value="none">YÃ¶nlendirme Yok (UygulamayÄ± AÃ§)</option>
                    <option value="halka-arz">ğŸ“Š Halka Arz SayfasÄ±</option>
                    <option value="ai-haberler">ğŸ“° KAP Haber SayfasÄ±</option>
                    <option value="ayarlar">âš™ï¸ Ayarlar SayfasÄ±</option>
                </select>
            </div>

            <!-- Ã–nizleme -->
            <div class="mb-6 bg-gray-900 rounded-lg border border-gray-600 p-4">
                <h3 class="text-sm font-medium text-gray-400 mb-3">Ã–nizleme</h3>

                <!-- Telefon bildirim mockup -->
                <div class="bg-gray-700 rounded-xl p-3 max-w-sm shadow-md">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-xl
                                    flex items-center justify-center text-xs font-bold shrink-0 text-white shadow">
                            SZ
                        </div>
                        <div class="min-w-0 flex-1">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-400 text-xs">BIST Haber & Arz</span>
                                <span class="text-gray-500 text-xs">ÅŸimdi</span>
                            </div>
                            <div id="previewTitle" class="font-semibold text-gray-100 text-sm mt-0.5">
                                Bildirim baÅŸlÄ±ÄŸÄ±
                            </div>
                            <div id="previewBody" class="text-gray-400 text-xs mt-0.5 line-clamp-3">
                                Bildirim mesajÄ± buraya gelecek...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AlÄ±cÄ± sayÄ±sÄ± -->
                <div class="mt-3 flex items-center justify-between">
                    <span class="text-sm text-gray-400">
                        Tahmini alÄ±cÄ±:
                        <span id="recipientCount" class="font-bold text-indigo-400">â€”</span>
                    </span>
                    <button type="button" onclick="updatePreview()"
                            class="text-xs text-indigo-400 hover:text-indigo-300 transition">
                        â†» Yenile
                    </button>
                </div>
            </div>

            <!-- GÃ¶nder butonu -->
            <button type="submit" id="sendBtn"
                    class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3
                           rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed
                           flex items-center justify-center gap-2"
                    {{ 'disabled' if not can_send else '' }}>
                <span>ğŸ“¢</span>
                <span>Bildirimi GÃ¶nder</span>
            </button>

            {% if not can_send %}
            <p class="text-center text-yellow-400 text-xs mt-2">
                Rate limit aktif â€” {{ cooldown_remaining }} saniye sonra tekrar deneyebilirsiniz
            </p>
            {% endif %}
        </form>
    </div>

    <!-- Bilgi notu -->
    <div class="bg-gray-800/50 rounded-lg border border-gray-700 p-4 text-sm text-gray-500">
        <p class="flex items-center gap-1.5">
            <span>â„¹ï¸</span>
            Bildirimler arka planda gÃ¶nderilir. SonuÃ§ Telegram'a raporlanÄ±r.
            GÃ¶nderimler arasÄ± 2 saniye beklenir (Firebase korumasÄ±).
            Her 5 dakikada 1 broadcast gÃ¶nderilebilir.
        </p>
    </div>
</div>

<script>
// Karakter sayaÃ§larÄ± + canlÄ± Ã¶nizleme
const titleInput = document.getElementById('titleInput');
const bodyInput = document.getElementById('bodyInput');

titleInput.addEventListener('input', function() {
    document.getElementById('titleCount').textContent = this.value.length;
    document.getElementById('previewTitle').textContent =
        this.value || 'Bildirim baÅŸlÄ±ÄŸÄ±';
});

bodyInput.addEventListener('input', function() {
    document.getElementById('bodyCount').textContent = this.value.length;
    document.getElementById('previewBody').textContent =
        this.value || 'Bildirim mesajÄ± buraya gelecek...';
});

// Hedef kitle deÄŸiÅŸince alÄ±cÄ± sayÄ±sÄ±nÄ± AJAX ile gÃ¼ncelle
async function updatePreview() {
    const audience = document.querySelector('[name="audience"]:checked').value;
    const countEl = document.getElementById('recipientCount');
    countEl.textContent = 'HesaplanÄ±yor...';

    try {
        const formData = new FormData();
        formData.append('audience', audience);

        const resp = await fetch('/admin/broadcast/preview', {
            method: 'POST',
            body: formData,
        });

        if (!resp.ok) throw new Error('HTTP ' + resp.status);

        const data = await resp.json();
        countEl.textContent = data.count + ' kullanÄ±cÄ±';
    } catch (e) {
        countEl.textContent = 'Hata â€” tekrar deneyin';
    }
}

// Sayfa yÃ¼klenince ilk sorgu
updatePreview();

// Onay dialogu
function confirmBroadcast() {
    const title = titleInput.value.trim();
    const body = bodyInput.value.trim();
    const audience = document.querySelector('[name="audience"]:checked').value;
    const count = document.getElementById('recipientCount').textContent;

    const audienceLabels = {
        all: 'TÃœM KULLANICILAR',
        paid: 'ÃœCRETLÄ° ABONELER',
        free: 'ÃœCRETSÄ°Z KULLANICILAR'
    };

    if (!title || !body) {
        alert('BaÅŸlÄ±k ve mesaj alanlarÄ± boÅŸ bÄ±rakÄ±lamaz!');
        return false;
    }

    return confirm(
        'âš ï¸ DÄ°KKAT: Bu iÅŸlem geri alÄ±namaz!\n\n' +
        'ğŸ“‹ BaÅŸlÄ±k: ' + title + '\n' +
        'ğŸ‘¥ Hedef: ' + audienceLabels[audience] + '\n' +
        'ğŸ“Š Tahmini alÄ±cÄ±: ' + count + '\n\n' +
        'Bildirimi gÃ¶ndermek istediÄŸinizden emin misiniz?'
    );
}
</script>
{% endblock %}
